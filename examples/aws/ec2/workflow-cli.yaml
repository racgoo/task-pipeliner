name: EC2 Deploy (SSH)

# 1) Load EC2 connection from env.example via cat + KV capture
# 2) Prompt for the deploy command to run on the server
# 3) Run it via SSH
# Edit env.example with your values. Run from this directory. Requires: OpenSSH (ssh).

baseDir: ./

steps:
  - run: 'cat env.example'
    captures:
      - kv: EC2_HOST
        as: EC2_HOST
      - kv: SSH_USER
        as: SSH_USER
      - kv: SSH_KEY_PATH
        as: SSH_KEY_PATH
  - prompt:
      message: "Deploy command to run on server:"
      default: "cd /var/www/app && git pull && npm install --production && pm2 restart all"
      as: deploy_command
  - run: 'ssh -i "{{SSH_KEY_PATH}}" -o StrictHostKeyChecking=accept-new {{SSH_USER}}@{{EC2_HOST}} "{{deploy_command}}"'
  - run: 'echo "Deploy finished."'
