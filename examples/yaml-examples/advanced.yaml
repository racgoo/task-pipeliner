name: Advanced Workflow Example

steps:
  # 1. Initial build and test (parallel with timeout)
  - parallel:
      - run: 'echo "Building frontend..."'
        timeout: 300  # 5 minutes
      - run: 'echo "Building backend..."'
        timeout: 300  # 5 minutes
      - run: 'echo "Running unit tests..."'
        timeout: 180  # 3 minutes

  # 2. Verify build output (file existence)
  - when:
      file: ./dist/frontend
    run: 'echo "Frontend build completed"'

  - when:
      file: ./dist/backend
    run: 'echo "Backend build completed"'

  # 3. Select environment (first choose)
  - choose:
      message: "Select deployment environment:"
      options:
        - id: dev
          label: "Development"
        - id: staging
          label: "Staging"
        - id: prod
          label: "Production"
      as: env

  # 4. Environment-specific additional settings
  - when:
      var:
        env: prod
    choose:
      message: "Production requires approval. Continue?"
      options:
        - id: approve_prod
          label: "Yes, deploy to production"
        - id: cancel_prod
          label: "Cancel"
      as: prodApproval

  # 5. Confirm production approval
  - when:
      all:
        - var:
            env: prod
        - var:
            prodApproval: approve_prod
    run: 'echo "Production deployment approved"'

  # 6. Cancel production
  - when:
      all:
        - var:
            env: prod
        - var:
            prodApproval: cancel_prod
    fail:
      message: "Production deployment cancelled by user"

  # 7. Select deployment strategy (Staging/Production)
  - when:
      any:
        - var:
            env: staging
        - var:
            prodApproval: approve_prod
    choose:
      message: "Select deployment strategy:"
      options:
        - id: blue_green
          label: "Blue-Green Deployment"
        - id: rolling
          label: "Rolling Update"
        - id: canary
          label: "Canary Release"
      as: strategy

  # 8. Complex parallel deployment (multiple services)
  - when:
      any:
        - var:
            env: staging
        - var:
            prodApproval: approve_prod
    parallel:
      - when:
          any:
            - var:
                strategy: blue_green
            - var:
                strategy: canary
        run: 'echo "Deploying web service..."'
      
      - when:
          any:
            - var:
                strategy: blue_green
            - var:
                strategy: rolling
        run: 'echo "Deploying API service..."'
      
      - when:
          var:
            strategy: canary
        run: 'echo "Deploying canary version..."'
      
      - when:
          var:
            strategy: rolling
        run: 'echo "Rolling update in progress..."'

  # 9. Post-deployment verification (parallel)
  - when:
      any:
        - var:
            strategy: blue_green
        - var:
            strategy: rolling
        - var:
            strategy: canary
    parallel:
      - run: 'echo "Running smoke tests..."'
      - run: 'echo "Checking health endpoints..."'
      - when:
          var:
            strategy: canary
        run: 'echo "Monitoring canary metrics..."'

  # 10. Production-only additional verification
  - when:
      all:
        - var:
            prodApproval: approve_prod
        - file: ./test-results/smoke.json
    parallel:
      - run: 'echo "Running security scan..."'
      - run: 'echo "Running performance tests..."'

  # 11. Final approval (Production)
  - when:
      all:
        - var:
            prodApproval: approve_prod
        - file: ./test-results/security.json
    choose:
      message: "All checks passed. Final approval for production?"
      options:
        - id: final_approve
          label: "Yes, proceed to production"
        - id: final_cancel
          label: "No, abort deployment"
      as: finalApproval

  # 12. Final deployment or cancellation (with timeout, retry, and rollback on failure)
  - when:
      all:
        - var:
            prodApproval: approve_prod
        - var:
            finalApproval: final_approve
    run: 'echo "ðŸš€ Deploying to production..."'
    timeout: 600  # 10 minutes
    retry: 3  # Retry up to 3 times for critical production deployment
    onError:
      run: 'echo "Deployment failed, running rollback..."'
  # Note: If you want to record failure but still continue to the next step, add:
  #   continue: true

  - when:
      all:
        - var:
            prodApproval: approve_prod
        - var:
            finalApproval: final_cancel
    fail:
      message: "Production deployment cancelled at final step"

  # 13. Deployment completion notification
  - when:
      any:
        - var:
            env: dev
        - var:
            env: staging
        - var:
            finalApproval: final_approve
    run: 'echo "âœ… Deployment completed successfully!"'
