name: update-package-managers

on:
  release:
    types: [published]
  workflow_run:
    workflows: ["Release Build and Publish"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write

jobs:
  update-homebrew:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'release' && github.event.release.prerelease == false) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout Homebrew tap
        uses: actions/checkout@v4
        with:
          repository: racgoo/homebrew-task-pipeliner
          token: ${{ secrets.PACKAGE_MANAGER_TOKEN || secrets.GITHUB_TOKEN }}
          path: homebrew-tap
          fetch-depth: 0
          persist-credentials: true

      - name: Initialize repository if empty
        working-directory: homebrew-tap
        run: |
          if [ ! -d .git ]; then
            git init
            git remote add origin https://github.com/racgoo/homebrew-task-pipeliner.git
            git checkout -b main || git branch -M main
          fi

      - name: Get version and tag from release
        id: release_info
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
            VERSION="${TAG#v}"
          else
            # Get latest release tag from workflow_run using GitHub API
            TAG=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/latest" | \
              grep -o '"tag_name": "[^"]*' | cut -d'"' -f4)
            VERSION="${TAG#v}"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Calculate SHA256 for binaries
        id: shas
        run: |
          TAG="${{ steps.release_info.outputs.tag }}"
          REPO="${{ github.repository }}"
          
          MACOS_ARM64_SHA=$(curl -sL "https://github.com/${REPO}/releases/download/${TAG}/tp-macos-arm64" | shasum -a 256 | cut -d' ' -f1)
          MACOS_X64_SHA=$(curl -sL "https://github.com/${REPO}/releases/download/${TAG}/tp-macos-x64" | shasum -a 256 | cut -d' ' -f1)
          LINUX_X64_SHA=$(curl -sL "https://github.com/${REPO}/releases/download/${TAG}/tp-linux-x64" | shasum -a 256 | cut -d' ' -f1)
          
          echo "macos_arm64_sha=${MACOS_ARM64_SHA}" >> $GITHUB_OUTPUT
          echo "macos_x64_sha=${MACOS_X64_SHA}" >> $GITHUB_OUTPUT
          echo "linux_x64_sha=${LINUX_X64_SHA}" >> $GITHUB_OUTPUT

      - name: Generate Homebrew Formula
        working-directory: homebrew-tap
        run: |
          VERSION="${{ steps.release_info.outputs.version }}"
          TAG="${{ steps.release_info.outputs.tag }}"
          REPO="${{ github.repository }}"
          
          mkdir -p Formula
          cat > Formula/task-pipeliner.rb <<FORMULA_EOF
          class TaskPipeliner < Formula
            desc "A task pipeline runner with condition-based workflow execution"
            homepage "https://task-pipeliner.racgoo.com"
            license "MIT"
            version "${VERSION}"
            
            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/${REPO}/releases/download/${TAG}/tp-macos-arm64"
                sha256 "${{ steps.shas.outputs.macos_arm64_sha }}"
              else
                url "https://github.com/${REPO}/releases/download/${TAG}/tp-macos-x64"
                sha256 "${{ steps.shas.outputs.macos_x64_sha }}"
              end
            end
            
            on_linux do
              url "https://github.com/${REPO}/releases/download/${TAG}/tp-linux-x64"
              sha256 "${{ steps.shas.outputs.linux_x64_sha }}"
            end
            
            def install
              bin.install Dir["tp-*"].first => "tp"
              bin.install_symlink "tp" => "task-pipeliner"
            end
            
            test do
              system "#{bin}/tp", "--version"
            end
          end
          FORMULA_EOF

      - name: Commit and push Formula
        working-directory: homebrew-tap
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$(pwd)"
          git add Formula/task-pipeliner.rb
          # Always commit to ensure SHA256 is up to date (even for same version)
          git commit -m "Update task-pipeliner to ${{ steps.release_info.outputs.version }}" || echo "No changes or already up to date"
          git push origin main || git push origin HEAD:main || echo "Push failed or no changes"

  update-scoop:
    name: Update Scoop Manifest
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'release' && github.event.release.prerelease == false) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout Scoop bucket
        uses: actions/checkout@v4
        with:
          repository: racgoo/scoop-task-pipeliner
          token: ${{ secrets.PACKAGE_MANAGER_TOKEN || secrets.GITHUB_TOKEN }}
          path: scoop-bucket
          fetch-depth: 0
          persist-credentials: true

      - name: Initialize repository if empty
        working-directory: scoop-bucket
        run: |
          if [ ! -d .git ]; then
            git init
            git remote add origin https://github.com/racgoo/scoop-task-pipeliner.git
            git checkout -b main || git branch -M main
          fi

      - name: Get version and tag from release
        id: release_info
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
            VERSION="${TAG#v}"
          else
            # Get latest release tag from workflow_run using GitHub API
            TAG=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/latest" | \
              grep -o '"tag_name": "[^"]*' | cut -d'"' -f4)
            VERSION="${TAG#v}"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Calculate SHA256 for Windows binary
        id: shas
        run: |
          TAG="${{ steps.release_info.outputs.tag }}"
          REPO="${{ github.repository }}"
          
          WIN_X64_SHA=$(curl -sL "https://github.com/${REPO}/releases/download/${TAG}/tp-win-x64.exe" | shasum -a 256 | cut -d' ' -f1)
          
          echo "win_x64_sha=${WIN_X64_SHA}" >> $GITHUB_OUTPUT

      - name: Generate Scoop Manifest
        working-directory: scoop-bucket
        run: |
          VERSION="${{ steps.release_info.outputs.version }}"
          TAG="${{ steps.release_info.outputs.tag }}"
          REPO="${{ github.repository }}"
          
          # Scoop bucket은 루트에 파일을 둡니다
          cat > task-pipeliner.json <<EOF
          {
            "version": "${VERSION}",
            "description": "A task pipeline runner with condition-based workflow execution",
            "homepage": "https://task-pipeliner.racgoo.com",
            "license": "MIT",
            "url": "https://github.com/${REPO}/releases/download/${TAG}/tp-win-x64.exe",
            "hash": "${{ steps.shas.outputs.win_x64_sha }}",
            "bin": [["tp-win-x64.exe", "tp"]],
            "checkver": {
              "github": "${REPO}"
            },
            "autoupdate": {
              "url": "https://github.com/${REPO}/releases/download/v\$version/tp-win-x64.exe"
            }
          }
          EOF

      - name: Commit and push Manifest
        working-directory: scoop-bucket
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$(pwd)"
          git add task-pipeliner.json
          # Always commit to ensure hash is up to date (even for same version)
          git commit -m "Update task-pipeliner to ${{ steps.release_info.outputs.version }}" || echo "No changes or already up to date"
          git push origin main || git push origin HEAD:main || echo "Push failed or no changes"

  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'release' && github.event.release.prerelease == false) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: 'https://registry.npmjs.org'
          cache: pnpm

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: |
          just build-rs
          just build-ts

      - name: Publish to npm
        run: pnpm publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
